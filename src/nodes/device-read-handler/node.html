<script type="text/x-red" data-template-name="indysoft-device-read-handler">
  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
      <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>
  <div class="form-row" style="margin-bottom:0;">
      <label><i class="fa fa-list"></i> Responses</label>
  </div>
  <div class="form-row node-input-response-container-row">
      <ol id="node-input-response-container"></ol>
  </div>
</script>

<script type="text/x-red" data-help-name="indysoft-device-read-handler">
  <p>Provides a UI for building a sequence of commands and instructions that can later be sent to the Instrument Control Server for processing and data response.</p>
</script>

<script type="text/javascript">

  const indySoftResponseHandlerDefaults = {
    tagPropertyType: 'str',
    tag: '',
    payloadType: 'string'
  }

  function apendSelectField(row, className, options, label) {
    $('<div/>',{style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"}).text(label).appendTo(row);
    var field = $('<select/>', {
        class: className,
        style: 'width:110px; margin-right:10px;'
    }).appendTo(row);
    options.forEach(option => field.append($('<option></option>').val(option.value).text(option.label)));
    return field;
    }

  function appendTypedInput(row, className, label, types, type, value) {
    $('<div/>',{style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
        .text(label).appendTo(row);
    var field = $('<input/>', {
        class: className,
        type: 'text'
    });
    // Fields must be appended, before using typedInput.  Otherwise, it will be hidden.
    field.appendTo(row);
    field.typedInput({ types: types });
    field.typedInput('type', type);
    field.typedInput('value', value);
    return field;
  }

  RED.nodes.registerType('indysoft-device-read-handler', {
      color: '#F3B567',
      category: 'Bulk Operations',
      defaults: {
        name: { value: '' },
        outputs: { value: 1 },
        responses: { value: [indySoftResponseHandlerDefaults] }
      },
      inputs: 1,
      outputs: 1,
      icon: 'template.svg',
      label: function () {
        return this.name || 'Device Read Handler';
      },
      labelStyle: function () {
        return this.name ? 'node_label_italic' : '';
      },
      outputLabels: function(index) {
        return this.responses[index].tag;
      },
      paletteLabel: 'Device Read Handler',
      oneditprepare: function() {
        var container = $('#node-input-response-container');

        function resizeResponse(row) {
          var newWidth = row.width();
          row.find('.red-ui-typedInput').typedInput('width', newWidth - 130);
        }

        container.css('min-height', '300px');
        container.css('min-width', '450px');
        container.editableList({
          addItem: function (row, index, response) {
            if (!response.hasOwnProperty('tag')) {
              response = indySoftResponseHandlerDefaults;
            }

            row.css({
                overflow: 'hidden',
                whiteSpace: 'nowrap'
            });

            // === row 2 ===
            var row1 = $('<div/>', { style:"margin-top:8px;" }).appendTo(row);
            // responseTag field
            var responseTagField = appendTypedInput(row1, 'node-input-response-tag', 'Tag', ['msg', 'flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date', 'jsonata', 'env'], response.tagPropertyType, response.tag);

            // === row 2 ===
            var row2 = $('<div/>', { style:"margin-top:8px;" }).appendTo(row);
            // payloadType select field
            var payloadTypeSelectFieldOptions = [{
            label: 'String',
                value: 'string'
            },
            {
                label: 'Boolean',
                value: 'boolean'
            },
            {
                label: 'Byte',
                value: 'byte'
            },
            {
                label: 'Character',
                value: 'char'
            },
            {
                label: 'Int16',
                value: 'int16'
            },
            {
                label: 'Int32',
                value: 'int32'
            },
            {
                label: 'Int64',
                value: 'int64'
            },
            {
                label: 'Float32',
                value: 'float32'
            },
            {
                label: 'Float64',
                value: 'float64'
            },
            {
                label: 'Byte array',
                value: 'byteArray'
            }]
            var payloadTypeSelectField = apendSelectField(row2, 'node-input-payload-type', payloadTypeSelectFieldOptions, 'Payload Type');
            payloadTypeSelectField.val(response.payloadType);
            payloadTypeSelectField.change();
          },
          resizeItem: resizeResponse,
          removable: true,
          sortable: true
        });
        if (!this.responses) this.responses = [indySoftResponseHandlerDefaults];
        container.editableList('addItems', this.responses);
      },
      oneditsave: function() {
        var responses = $("#node-input-response-container").editableList('items');
        this.outputs = responses.length > 0 ? responses.length : 1;
        var node = this;
        node.responses = [];
        responses.each(function(index, response) {
          var tagField = response.find('.node-input-response-tag');
          var payloadType = response.find('.node-input-payload-type').val();
          var r = {
            tag: tagField.typedInput('value'),
            tagPropertyType: tagField.typedInput('type'),
            payloadType: payloadType
          };
          node.responses.push(r);
        });
      },
      oneditresize: function (size) {
        var rows = $('#dialog-form>div:not(.node-input-response-container-row)');
        var height = size.height;
        rows.each((index, row) => height -= $(row).outerHeight(true));
        var editorRow = $('#dialog-form>div.node-input-response-container-row');
        height -= (parseInt(editorRow.css('marginTop')) + parseInt(editorRow.css('marginBottom')));
        $('#node-input-response-container').editableList('height', height);
        }
    });
</script>