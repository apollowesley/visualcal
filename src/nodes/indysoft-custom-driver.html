<script type="text/html" data-template-name="indysoft-custom-driver">
  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <!-- Driver config -->
  <div class="form-row">
    <label for="node-input-driverConfigId"><i class="fa fa-tag"></i> Driver</label>
    <input type="text" id="node-input-driverConfigId" style="display: inline-block; width: auto; vertical-align: top;">
  </div>

  <div class="form-row node-input-instruction-sets-container-row">
    <ol id="node-input-instruction-sets-container"></ol>
  </div>

  <div class="form-tips"><b>Tip:</b> Example tip.</div>
</script>

<script type="text/javascript">
(function() {

  /**
   * @typedef CommandParameterListItem
   * @type {object}
   * @property {string} value
   * @property {string} text
   * 
   * @typedef CommandParameter
   * @type {object}
   * @property {string} id
   * @property {string} prompt
   * @property {string} type
   * @property {CommandParameterListItem[]} listItems
   * 
   * @typedef Instruction
   * @type {object}
   * @property {string} id
   * @property {string} name
   * @property {string} type
   * @property {string} command
   * @property {CommandParameter[]} parameters
   * 
   * @typedef InstructionSet
   * @type {object}
   * @property {string} id
   * @property {string} name
   * @property {Instruction[]} instructions
   * 
   * @typedef InstructionSetItemParameterArgument
   * @type {object}
   * @property {string} parameterId
   * 
   * @typedef InstructionSetItem
   * @type {object}
   * @property {string} instructionSetId - The ID of the instruction set being referenced by this item
   * @property {InstructionSetItemParameterArgument[]} parameterArguments - The arguments to the parameters of the instruction set referenced by this item
   * 
   * @typedef Driver
   * @type {object}
   * @property {string} id
   * @property {string} manufacturer
   * @property {string} model
   * @property {string} nomenclature
   * @property {InstructionSet[]} instructionSets
   * 
   * @typedef CommandParameterArgument
   * @type {object}
   * @property {string} instructionId
   * @property {string} parameterId
   * @property {string} value
   * 
   * @typedef InstructionSetToRuntime
   * @type {object}
   * @property {string} id
   * @property {InstructionSet} instructionSet
   * @property {CommandParameterArgument[]} parameterArguments
   * 
  */

  /** @type {Driver} */
  let driver;

  /**
   * @param {JQueryEventObject} eventObject
   * @returns {string|undefined}
   */ 
  function getSelectedOptionValue(eventObject) {
    for (const option of eventObject.target.options) {
      if (option.selected) return option.value;
    }
  }

  RED.nodes.registerType('indysoft-custom-driver', {
    category: 'common',
    color: '#a6bbcf',
    defaults: {
      name: { value: '' },
      driverConfigId: { type: 'indysoft-custom-driver-configuration', required: true },
      instructionSets: { value: [] }
    },
    inputs: 1,
    outputs: 2,
    icon: "circuit.png",
    label: function () {
      return this.name || 'Custom Driver';
    },
    labelStyle: function () {
      return this.name ? 'node_label_italic' : '';
    },
    paletteLabel: 'Custom Driver',
    outputLabels: function (index) {
      if (index === 0) return 'Error';
      return 'Data';
    },
    oneditprepare: function () {
      let firstRunCompleted = false;
      const driverConfigIdElement = $('#node-input-driverConfigId');
      const instructionSetsContainerElement = $('#node-input-instruction-sets-container');

      const resizeInstructionSetItem = (instructionSetElement) => {

      }

      // Build the Instruction Sets list
      instructionSetsContainerElement.css('min-height', '150px').css('min-width', '450px').editableList({
        header: $("<div>").append($.parseHTML('<div display: inline-grid">Instruction Sets</div>')),
        /**
         * @param {JQuery} rowContainer - The container
         * @param {number} index - The index of the item
         * @param {InstructionSetToRuntime newItem - The new item being added
        */
        addItem: (rowContainer, index, newItem) => {
          // container.css({
          //   overflow: 'hidden',
          //   whiteSpace: 'nowrap'
          // });
          const row1 = $('<div/>', { style: 'padding-top: 5px;' }).addClass('instruction-set-row').appendTo(rowContainer);
          const instructionSetSelectLabelElement = $('<label/>').text('Instruction Set').appendTo(row1);
          const instructionSetSelectElement = $('<select/>', { style: 'text-align: center;' }).appendTo(row1);
          if (driver) {
            for (let index = 0; index < driver.instructionSets.length; index++) {
              /** @type {InstructionSet} */
              const instructionSet = driver.instructionSets[index];
              instructionSetSelectElement.append(`<option value="${instructionSet.id}" ${index === 0 ? 'selected' : ''}>${instructionSet.name}</option>`).addClass('instruction-set-select');
              instructionSetSelectElement.change(eventObject => {
                /** @type {string} */
                const selectedInstructionSetId = getSelectedOptionValue(eventObject);
                rowContainer.children('.parameter-row').remove();
                if (selectedInstructionSetId) {
                  /** @type {InstructionSet} */
                  const selectedInstructionSet = driver.instructionSets.find(i => i.id === selectedInstructionSetId);
                  selectedInstructionSet.instructions.forEach(instruction => {
                  if (instruction.parameters) {
                    instruction.parameters.forEach(parameter => {
                      const parameterRow = $('<div/>', { style: 'padding-top: 5px;' }).addClass('parameter-row').appendTo(rowContainer);
                      switch (parameter.type) {
                        case 'list':
                          const labelElement = $('<label/>').text(parameter.prompt).appendTo(parameterRow);
                          const parameterSelectElement = $('<select/>', { style: 'text-align: center;' }).addClass(parameter.id).appendTo(parameterRow);
                          for (let index = 0; index < parameter.listItems.length; index++) {
                            const listItem = parameter.listItems[index];
                            parameterSelectElement.append(`<option value="${listItem.value}" ${index === 0 ? 'selected' : ''}>${listItem.text}</option>`);
                          };
                          const newItemCommandParameter = newItem.parameterArguments.find(p => p.parameterId === parameter.id);
                          if (newItemCommandParameter) parameterSelectElement.val(newItemCommandParameter.value);
                          break;
                        }
                      });
                    }
                  });
                }
              });
            };
            if (newItem.id) instructionSetSelectElement.val(newItem.id);
            instructionSetSelectElement.change();
          }
        },
        removable: true,
        /**
         * @param {InstructionSetItem} instructionSet - The instruction set item being removed
        */
        removeItem: (instructionSet) => {
        },
        resizeItem: resizeInstructionSetItem,
        sortable: true,
        /**
         * @param {InstructionSetItem[]} instructionSetElements - The instruction set items
        */
        sortItems: (instructionSetElements) => {

        }
      });

      const refreshUI = (driver) => {
        if (!driver) return;
        /** @type {InstructionSetToRuntime[]} */
        const instructionSets = this.instructionSets;
        if (instructionSets) {
          for (const instructionSet of instructionSets) {
            if (instructionSet && !firstRunCompleted) instructionSetsContainerElement.editableList('addItem', instructionSet);
          }
        }
        firstRunCompleted = true;
      }

      // Detect when driverConfigId changes so we can get the new driver info and refresh the UI
      driverConfigIdElement.change(async (eventObject) => {
        let configNode;
        driverConfigIdNodeId = getSelectedOptionValue(eventObject);
        RED.nodes.eachConfig((node) => {
          if (node.id === driverConfigIdNodeId) configNode = node;
        });
        if (configNode) {
          driver = await visualCal.getCustomDriver(configNode.manufacturer, configNode.model);
          if (driver) refreshUI(driver);
        }
      });
    },
    oneditsave: function() {
      /** @type {JQuery} */
      const instructionSetItemElements = $('#node-input-instruction-sets-container').editableList('items');
      const usedInstructionSets = [];
      instructionSetItemElements.each(function() {
        const instructionSetListItemElement = $(this);
        const instructionSetListItemDivElement = instructionSetListItemElement.children('.instruction-set-row');
        const instructionSetSelectElement = instructionSetListItemDivElement.children('.instruction-set-select');
        const selectedOptionElements = instructionSetSelectElement.children('option:selected');
        const instructionSet = driver.instructionSets.find(i => i.id === selectedOptionElements[0].value);
        /** @type {InstructionSetToRuntime} */
        const instructionSetInfoToRuntime = {
          id: instructionSet.id,
          instructionSet: instructionSet,
          parameterArguments: []
        }
        instructionSet.instructions.forEach(instruction => {
          if (instruction.parameters) {
            instruction.parameters.forEach(parameter => {
              const parameterRows = instructionSetListItemElement.children('.parameter-row');
              switch (parameter.type) {
                case 'list':
                  const parameterSelect = parameterRows.children(`.${parameter.id}`);
                  const parameterSelectSelectedOptionElements = parameterSelect.children('option:selected');
                  const selectedValue = parameterSelectSelectedOptionElements[0].value;
                  instructionSetInfoToRuntime.parameterArguments.push({ instructionId: instruction.id, parameterId: parameter.id, value: selectedValue });
                  break;
              }
            });
          }
        });
        if (selectedOptionElements && selectedOptionElements.length > 0) usedInstructionSets.push(instructionSetInfoToRuntime);
      });
      this.instructionSets = usedInstructionSets;
    },
    oneditresize: function(size) {
      let rows = $('#dialog-form>div:not(.node-input-instruction-sets-container-row)');
      let height = size.height;
      for (let i = 0; i < rows.length; i++) {
        height -= $(rows[i]).outerHeight(true);
      }
      let editorRow = $('#dialog-form>div.node-input-instruction-sets-container-row');
      height -= (parseInt(editorRow.css('marginTop')) + parseInt(editorRow.css('marginBottom')));
      height += 16;
      $('#node-input-instruction-sets-container').editableList('height', height);
    }
  });
})();
</script>

<script type="text/html" data-help-name="indysoft-custom-driver">
  <p>Some useful help text to introduce the node.</p>
  <h3>Outputs</h3>
      <dl class="message-properties">
      <dt>payload
          <span class="property-type">string | buffer</span>
      </dt>
  <h3>Details</h3>
  <p>Some more information about the node.</p>
</script>