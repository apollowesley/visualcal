<script type="text/html" data-template-name="indysoft-custom-driver">
  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <!-- Driver config -->
  <div class="form-row">
    <label for="node-input-driverConfigId"><i class="fa fa-tag"></i> Driver</label>
    <input type="text" id="node-input-driverConfigId" style="display: inline-block; width: auto; vertical-align: top;">
  </div>

  <div class="form-row node-input-instruction-sets-container-row">
    <ol id="node-input-instruction-sets-container"></ol>
  </div>

  <div class="form-tips"><b>Tip:</b> Example tip.</div>
</script>

<script type="text/javascript">
(function() {

  /**
   * @typedef CommandParameterListItem
   * @type {object}
   * @property {string} value
   * @property {string} text
   * 
   * @typedef CommandParameter
   * @type {object}
   * @property {string} id
   * @property {string} prompt
   * @property {string} type
   * @property {CommandParameterListItem[]} listItems
   * 
   * @typedef Instruction
   * @type {object}
   * @property {string} id
   * @property {string} name
   * @property {string} type
   * @property {string} command
   * @property {CommandParameter[]} parameters
   * 
   * @typedef InstructionSet
   * @type {object}
   * @property {string} id
   * @property {string} name
   * @property {Instruction[]} instructions
   * 
   * @typedef InstructionSetItemParameterArgument
   * @type {object}
   * @property {string} parameterId
   * 
   * @typedef InstructionSetItem
   * @type {object}
   * @property {string} instructionSetId - The ID of the instruction set being referenced by this item
   * @property {InstructionSetItemParameterArgument[]} parameterArguments - The arguments to the parameters of the instruction set referenced by this item
   * 
   * @typedef Driver
   * @type {object}
   * @property {string} id
   * @property {string} manufacturer
   * @property {string} model
   * @property {string} nomenclature
   * @property {InstructionSet[]} instructionSets
   * 
  */

  /** @type {Driver} */
  let driver;

  RED.nodes.registerType('indysoft-custom-driver', {
    category: 'common',
    color: '#a6bbcf',
    defaults: {
      name: { value: '' },
      driverConfigId: { type: 'indysoft-custom-driver-configuration', required: true },
      instructionSetIds: { value: [] }
    },
    inputs: 1,
    outputs: 2,
    icon: "circuit.png",
    label: function () {
      return this.name || 'Custom Driver';
    },
    labelStyle: function () {
      return this.name ? 'node_label_italic' : '';
    },
    paletteLabel: 'Custom Driver',
    outputLabels: function (index) {
      if (index === 0) return 'Error';
      return 'Data';
    },
    oneditprepare: function () {
      let firstRunCompleted = false;
      const driverConfigIdElement = $('#node-input-driverConfigId');
      const instructionSetsContainerElement = $('#node-input-instruction-sets-container');

      const resizeInstructionSetItem = (instructionSetElement) => {

      }

      // Build the Instruction Sets list
      instructionSetsContainerElement.css('min-height', '150px').css('min-width', '450px').editableList({
        header: $("<div>").append($.parseHTML('<div display: inline-grid">Instruction Sets</div>')),
        /**
         * @param {JQuery} rowContainer - The container
         * @param {number} index - The index of the item
         * @param {Object} newItem - The new item being added
        */
        addItem: (rowContainer, index, newItem) => {
          // container.css({
          //   overflow: 'hidden',
          //   whiteSpace: 'nowrap'
          // });
          const row1 = $('<div/>').appendTo(rowContainer);
          const row2 = $('<div/>', { style: 'padding-top: 5px;' }).appendTo(rowContainer);
          const instructionSetSelectLabelElement = $('<label>Instruction Set</label>', { style: 'margin-left: 8px; text-align: center;' }).appendTo(row1);
          const instructionSetSelectElement = $('<select/>', { style: 'margin-left: 5px; text-align: center;' }).appendTo(row2);
          if (driver) {
            for (let index = 0; index < driver.instructionSets.length; index++) {
              /** @type {InstructionSet} */
              const instructionSet = driver.instructionSets[index];
              instructionSetSelectElement.append(`<option value="${instructionSet.id}" ${index === 0 ? 'selected' : ''}>${instructionSet.name}</option>`);
              instructionSetSelectElement.change(eventObject => {
                /** @type {string} */
                let selectedInstructionSetId;
                for (const option of eventObject.target.options) {
                  if (!option.selected) continue;
                  selectedInstructionSetId = option.value;
                  break;
                }
                rowContainer.children('.parameter-row').remove();
                if (selectedInstructionSetId) {
                  /** @type {InstructionSet} */
                  const selectedInstructionSet = driver.instructionSets.find(i => i.id === selectedInstructionSetId);
                  selectedInstructionSet.instructions.forEach(instruction => {
                  if (instruction.parameters) {
                    instruction.parameters.forEach(parameter => {
                      const parameterRow = $('<div/>', { style: 'padding-top: 5px;' }).addClass('parameter-row').appendTo(rowContainer);
                      switch (parameter.type) {
                        case 'list':
                          const labelElement = $('<label/>').text(parameter.prompt).appendTo(parameterRow);
                          const parameterSelectElement = $('<select/>', { style: "margin-left: 5px; text-align: center;" }).appendTo(parameterRow);
                          for (let index = 0; index < parameter.listItems.length; index++) {
                            const listItem = parameter.listItems[index];
                            parameterSelectElement.append(`<option value="${listItem.value}" ${index === 0 ? 'selected' : ''}>${listItem.text}</option>`);
                          };
                          break;
                        }
                      });
                    }
                  });
                }
              });
            };
            if (newItem.id) instructionSetSelectElement.val(newItem.id);
            instructionSetSelectElement.change();
          }
        },
        removable: true,
        /**
         * @param {InstructionSetItem} instructionSet - The instruction set item being removed
        */
        removeItem: (instructionSet) => {
        },
        resizeItem: resizeInstructionSetItem,
        sortable: true,
        /**
         * @param {InstructionSetItem[]} instructionSetElements - The instruction set items
        */
        sortItems: (instructionSetElements) => {

        }
      });

      const refreshUI = (driver) => {
        if (!driver) return;
        for (const id of this.instructionSetIds) {
          const instructionSet = driver.instructionSets.find(i => i.id === id);
          if (instructionSet && !firstRunCompleted) instructionSetsContainerElement.editableList('addItem', instructionSet);
        }
        firstRunCompleted = true;
      }

      // Detect when driverConfigId changes so we can get the new driver info and refresh the UI
      driverConfigIdElement.change(async (eventObject) => {
        let configNode;
        let driverConfigIdNodeId = '';
        for (const option of eventObject.target.options) {
          if (!option.selected) continue;
          driverConfigIdNodeId = option.value;
          break;
        }
        RED.nodes.eachConfig((node) => {
          if (node.id === driverConfigIdNodeId) configNode = node;
        });
        if (configNode) {
          driver = await visualCal.getCustomDriver(configNode.manufacturer, configNode.model);
          if (driver) refreshUI(driver);
        }
      });
    },
    oneditsave: function() {
      /** @type {JQuery} */
      const instructionSetItemElements = $('#node-input-instruction-sets-container').editableList('items');
      const instructionSetIds = [];
      instructionSetItemElements.each(function() {
        const instructionSetListItemElement = $(this);
        const instructionSetListItemDivElement = instructionSetListItemElement.children('div');
        const selectElement = instructionSetListItemDivElement.children('select');
        const selectedOptionElements = selectElement.children('option:selected');
        if (selectedOptionElements && selectedOptionElements.length > 0) instructionSetIds.push(selectedOptionElements[0].value);
      });
      this.instructionSetIds = instructionSetIds;
    },
    oneditresize: function(size) {
      let rows = $('#dialog-form>div:not(.node-input-instruction-sets-container-row)');
      let height = size.height;
      for (let i = 0; i < rows.length; i++) {
        height -= $(rows[i]).outerHeight(true);
      }
      let editorRow = $('#dialog-form>div.node-input-instruction-sets-container-row');
      height -= (parseInt(editorRow.css('marginTop')) + parseInt(editorRow.css('marginBottom')));
      height += 16;
      $('#node-input-instruction-sets-container').editableList('height', height);
    }
  });
})();
</script>

<script type="text/html" data-help-name="indysoft-custom-driver">
  <p>Some useful help text to introduce the node.</p>
  <h3>Outputs</h3>
      <dl class="message-properties">
      <dt>payload
          <span class="property-type">string | buffer</span>
      </dt>
  <h3>Details</h3>
  <p>Some more information about the node.</p>
</script>