<script type="text/x-red" data-template-name="indysoft-custom-driver-configuration">
  <div class="form-row">
    <label for="node-config-input-unitId"><i class="fa fa-tag"></i> Unit Id</label>
    <input type="text" id="node-config-input-unitId">
  </div>
  <div class="form-row">
    <label for="node-config-input-manufacturer"><i class="fa fa-tag"></i> Manufacturer</label>
    <select id="node-config-input-manufacturer">
    </select>
  </div>
  <div class="form-row">
    <label for="node-config-input-model"><i class="fa fa-tag"></i> Model</label>
    <select id="node-config-input-model">
    </select>
  </div>
</script>

<script type="text/x-red" data-help-name="indysoft-custom-driver-configuration">
  <p>Provides a UI for defining a custom driver.</p>
</script>

<script type="text/javascript">
  /**
   * manufactuer: string, model: string, nomenclature: string
   * @typedef CustomDriverIdentityInfo
   * @type {object}
   * @property {string} manufacturer
   * @property {string} model
   * @property {string} nomenclature
   */

  (function () {
    RED.nodes.registerType('indysoft-custom-driver-configuration', {
      color: '#67F36E',
      category: 'config',
      defaults: {
        unitId: { value: '', required: true },
        manufacturer: { value: '', required: true },
        model: { value: '', required: true }
      },
      inputs: 0,
      outputs: 0,
      icon: 'template.svg',
      label: function() {
        return this.unitId || 'Custom Driver Configuration';
      },
      labelStyle: function() {
        return this.name ? 'node_label_italic' : '';
      },
      oneditprepare: async function() {
        /** @type {HTMLSelectElement} */
        const manufacturerSelectElement = document.getElementById('node-config-input-manufacturer');
        /** @type {HTMLSelectElement} */
        const modelSelectElement = document.getElementById('node-config-input-model');
        /** @type {CustomDriverIdentityInfo[]} */
        const driverIdentityInfos = await visualCal.getCustomDriverIdentityInfos();
        const manufacturers = driverIdentityInfos.map(d => d.manufacturer).filter((value, index, self) => self.indexOf(value) === index).sort();

        manufacturers.forEach(manufacturer => {
          const option = document.createElement('option');
          option.value = manufacturer;
          option.text = manufacturer;
          option.selected = manufacturer === this.manufacturer;
          manufacturerSelectElement.options.add(option);
        });

        manufacturerSelectElement.onchange = () => {
          const selectedOption = manufacturerSelectElement.options[manufacturerSelectElement.selectedIndex];
          for (let index = modelSelectElement.options.length - 1; index >= 0; index--) {
            modelSelectElement.remove(index);
          }
          if (!selectedOption) return;
          const manufacturer = selectedOption.value;
          const models = driverIdentityInfos.filter(d => d.manufacturer === manufacturer).map(d => d.model).sort();
          let optionWasSelected = false;
          models.forEach(model => {
            const option = document.createElement('option');
            option.value = model;
            option.text = model;
            if (model === this.model) {
              option.selected = true;
              optionWasSelected = true;
            }
            modelSelectElement.options.add(option);
          });
          if (!optionWasSelected) {
            const firstModelOption = modelSelectElement.options[0];
            if (firstModelOption) modelSelectElement.selected = true;
          }
        };

        $(manufacturerSelectElement).change();
      },
      oneditsave: function() {
        /** @type {HTMLSelectElement} */
        const manufacturerSelectElement = document.getElementById('node-config-input-manufacturer');
        /** @type {HTMLSelectElement} */
        const modelSelectElement = document.getElementById('node-config-input-model');
        const manufacturer = manufacturerSelectElement.options[manufacturerSelectElement.selectedIndex];
        const model = modelSelectElement.options[modelSelectElement.selectedIndex];
        if (!manufacturer || !model) return;
        this.manufacturer = manufacturer;
        this.model = model;
      }
    })
  })();

</script>