<script type="text/x-red" data-template-name="indysoft-command-sequence-builder">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-respondInBulk"> Respond in bulk</label>
        <input type="checkbox" id="node-input-respondInBulk" style="display: inline-block; width: auto; vertical-align: top;">
    </div>
    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> Operations</label>
    </div>
    <div class="form-row node-input-operation-container-row">
        <ol id="node-input-operation-container"></ol>
    </div>
</script>

<script type="text/x-red" data-help-name="indysoft-command-sequence-builder">
    <p>Provides a UI for building a sequence of commands and instructions that can later be sent to the Instrument Control Server for processing and data response.</p>
</script>

<script type="text/javascript">

    const defaultCommandSequenceBuilderOperation = function() {
        return {
            type: 'command',
            unitIdPropertyType: 'str',
            unitId: '',
            interfaceIdPropertyType: 'str',
            interfaceId: '',
            commandType: 'write', // write, read, query
            writeData: '',
            writeDataPropertyType: 'str',
            writeDataType: 'string', // string, integer, byteArray, float32, float64. May not be important, included for now
            readDataTypePropertyType: 'str',
            readDataType: 'string',
            readLength: 0,
            useReadLength: false,
            responseTagPropertyType: 'str',
            responseTag: '',
            resetType: 'device',
            delayPropertyType: 'num',
            delay: 1000
        }
    }

    function validateOperation(operation) {
        var isValid = true;
        switch (operation.type) {
            case 'command':
                if (!operation.unitId) {
                    isValid = false;
                };
                if (operation.commandType === 'read' || operation.commandType === 'query') {
                    if (!operation.readDataType) {
                        isValid = false;
                    }
                    if (operation.useReadLength && (!operation.readLength || operation.readLength <= 0)) {
                        isValid = false;
                    }
                    if (!operation.responseTag) {
                        isValid = false;
                    }
                }
                if (operation.commandType === 'write' || operation.commandType === 'query') {
                    if (!operation.writeData) {
                        isValid = false;
                    }
                }
                break;
            case 'delay':
                if (!operation.delay || operation.delay <= 0) {
                    isValid = false;
                }
                break;
            case 'reset':
                if (!operation.resetType) {
                    isValid = false;
                } else {
                    switch (operation.resetType) {
                        case 'device':
                            if (!operation.unitId) {
                                isValid = false;
                            }
                            break;
                        case 'interface':
                            if (!operation.interfaceId) {
                                isValid = false;
                            }
                            break;
                        default:
                            isValid = false;
                    }
                }
                break;
            case 'trigger':
                if (!operation.unitId) {
                    isValid = false;
                }
                break;
            default:
                isValid = false;
        }
        return isValid;
    }

    RED.nodes.registerType('indysoft-command-sequence-builder', {
        color: '#F3B567',
        category: 'Bulk Operations',
        defaults: {
            name: {
                value: '',
                required: false
            },
            respondInBulk: {
                value: true,
                required: true
            },
            operations: {
                value: []
                // Removed validation, for now.  node.js file works, as expected, but this validation reports an error during deploy, 
                // but I can't log it from here, for now.
                // validate: validateOperation
            }
        },
        inputs: 1,
        outputs: 1,
        icon: 'template.svg',
        label: function () {
            return this.name || 'Command Sequence Builder';
        },
        labelStyle: function () {
            return this.name ? 'node_label_italic' : '';
        },
        paletteLabel: 'Command Sequence Builder',
        oneditprepare: function () {
            var apendSelectField = function(row, className, options) {
                var field = $('<select/>', {
                    class: className,
                    style: 'width:110px; margin-right:10px;'
                }).appendTo(row);
                options.forEach(option => field.append($('<option></option>').val(option.value).text(option.label)));
                return field;
            }

            var appendTypedInput = function(row, className, label, types, type, value) {
                $('<div/>',{style:"display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                    .text(label).appendTo(row);
                var field = $('<input/>', {
                    class: className,
                    type: 'text'
                });
                // Fields must be appended, before using typedInput.  Otherwise, it will be hidden.
                field.appendTo(row);
                field.typedInput({ types: types });
                field.typedInput('type', type);
                field.typedInput('value', value);
                return field;
            }

            var container = $('#node-input-operation-container');

            var operationTypeLabel = this._('indySoft.commandSequenceBuilderdBuilder.operationType.label');
            var operationCommandTypeLabel = this._('indySoft.commandSequenceBuilder.operationCommandType.label');

            var operationUnitIdLabel = this._('indySoft.commandSequenceBuilder.label.unitId');
            var operationInterfaceIdLabel = this._('indySoft.commandSequenceBuilder.label.interfaceId');

            var operationTypeCommandLabel = this._('indySoft.commandSequenceBuilder.operationType.option.command');
            var operationTypeDelayLabel = this._('indySoft.commandSequenceBuilder.operationType.option.delay');
            var operationTypeResetLabel = this._('indySoft.commandSequenceBuilder.operationType.option.reset');
            var operationTypeTriggerLabel = this._('indySoft.commandSequenceBuilder.operationType.option.trigger');

            var operationCommandTypeWriteDataLabel = this._('indySoft.commandSequenceBuilder.operationCommandType.label.writeData');
            var operationCommandTypeResponseTagLabel = this._('indySoft.commandSequenceBuilder.operationCommandType.label.responseTag')

            var operationCommandTypeReadLabel = this._('indySoft.commandSequenceBuilder.operationCommandType.option.read');
            var operationCommandTypeWriteLabel = this._('indySoft.commandSequenceBuilder.operationCommandType.option.write');
            var operationCommandTypeQueryLabel = this._('indySoft.commandSequenceBuilder.operationCommandType.option.query');

            var operationReadDataTypeStringLabel = this._('indySoft.commandSequenceBuilder.operationReadDataType.option.string');
            var operationReadDataTypeIntegerLabel = this._('indySoft.commandSequenceBuilder.operationReadDataType.option.integer');
            var operationReadDataTypeSingleLabel = this._('indySoft.commandSequenceBuilder.operationReadDataType.option.single');
            var operationReadDataTypeDoubleLabel = this._('indySoft.commandSequenceBuilder.operationReadDataType.option.double');
            var operationReadDataTypeByteArrayLabel = this._('indySoft.commandSequenceBuilder.operationReadDataType.option.byteArray');

            var operationDelayLabel = this._('indySoft.commandSequenceBuilder.operationDelay.label');

            var operationResetTypeDeviceLabel = this._('indySoft.commandSequenceBuilder.operationResetType.label.device');
            var operationResetTypeInterfaceLabel = this._('indySoft.commandSequenceBuilder.operationResetType.label.interface');

            function resizeOperation(row) {
                var newWidth = row.width();
                row.find('.red-ui-typedInput').typedInput('width', newWidth - 130);
            }

            container.css('min-height', '300px');
            container.css('min-width', '450px');
            container.editableList({
                addItem: function (row, index, operation) {
                    if (!operation.hasOwnProperty('type')) {
                        operation = defaultCommandSequenceBuilderOperation;
                    }

                    row.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });

                    // === row 1 ===
                    var row1 = $('<div/>').appendTo(row);
                    // type select field
                    var typeSelectFieldOptions = [{
                        label: operationTypeCommandLabel,
                        value: 'command'
                    },
                    {
                        label: operationTypeDelayLabel,
                        value: 'delay'
                    },
                    {
                        label: operationTypeResetLabel,
                        value: 'reset'
                    },
                    {
                        label: operationTypeTriggerLabel,
                        value: 'trigger'
                    }];
                    var typeSelectField = apendSelectField(row1, 'node-input-operation-type', typeSelectFieldOptions);

                    // commandType select field
                    var commandTypeSelectFieldOptions = [{
                        label: operationCommandTypeReadLabel,
                        value: 'read'
                    },
                    {
                        label: operationCommandTypeWriteLabel,
                        value: 'write'
                    },
                    {
                        label: operationCommandTypeQueryLabel,
                        value: 'query'
                    }]
                    var commandTypeSelectField = apendSelectField(row1, 'node-input-operation-command-type', commandTypeSelectFieldOptions);

                    // readDataType select field
                    var readDataTypeSelectFieldOptions = [{
                        label: 'String',
                        value: 'string'
                    },
                    {
                        label: 'Boolean',
                        value: 'boolean'
                    },
                    {
                        label: 'Byte',
                        value: 'byte'
                    },
                    {
                        label: 'Character',
                        value: 'char'
                    },
                    {
                        label: 'Int16',
                        value: 'int16'
                    },
                    {
                        label: 'Int32',
                        value: 'int32'
                    },
                    {
                        label: 'Int64',
                        value: 'int64'
                    },
                    {
                        label: 'Float32',
                        value: 'float32'
                    },
                    {
                        label: 'Float64',
                        value: 'float64'
                    },
                    {
                        label: 'Byte array',
                        value: 'byteArray'
                    }]
                    var readDataTypeSelectField = apendSelectField(row1, 'node-input-operation-read-data-type', readDataTypeSelectFieldOptions);

                    // readDataType select field
                    var resetTypeSelectFieldOptions = [{
                        label: operationResetTypeDeviceLabel,
                        value: 'device'
                    },
                    {
                        label: operationResetTypeInterfaceLabel,
                        value: 'interface'
                    }]
                    var resetTypeSelectField = apendSelectField(row1, 'node-input-operation-reset-type', resetTypeSelectFieldOptions);

                    // === row 2 ===
                    var row2 = $('<div/>', { style:"margin-top:8px;" }).appendTo(row);
                    // unitId field
                    var unitIdField = appendTypedInput(row2, 'node-input-operation-unitId', operationUnitIdLabel, ['msg', 'flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date', 'jsonata', 'env'], operation.unitIdPropertyType, operation.unitId);

                    // === row 3 ===
                    var row3 = $('<div/>', { style:"margin-top:8px;" }).appendTo(row);
                    // writeData field
                    var writeDataField = appendTypedInput(row3, 'node-input-operation-write-data', operationCommandTypeWriteDataLabel, ['msg', 'flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date', 'jsonata', 'env'], operation.writeDataPropertyType, operation.writeData);

                    // === row 4 ===
                    var row4 = $('<div/>', { style:"margin-top:8px;" }).appendTo(row);
                    // responseTag field
                    var responseTagField = appendTypedInput(row4, 'node-input-operation-response-tag', operationCommandTypeResponseTagLabel, ['msg', 'flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date', 'jsonata', 'env'], operation.responseTagPropertyType, operation.responseTag);

                    // === row 5 ===
                    var row5 = $('<div/>', { style:"margin-top:8px;" }).appendTo(row);
                    // delay field
                    var delayField = appendTypedInput(row5, 'node-input-operation-delay', operationDelayLabel, ['msg', 'flow', 'global', 'num', 'json', 'jsonata', 'env'], operation.delayPropertyType, operation.delay);

                    // === row 6 ===
                    var row6 = $('<div/>', { style:"margin-top:8px;" }).appendTo(row);
                    // delay field
                    var resetTypeField = appendTypedInput(row6, 'node-input-operation-interfaceId', operationInterfaceIdLabel, ['msg', 'flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date', 'jsonata', 'env'], operation.interfaceIdPropertyType, operation.interfaceId);

                    function updateVisibleFieldsAndRows() {
                        var type = typeSelectField.val();
                        var commandType = commandTypeSelectField.val();
                        switch (type) {
                            case 'command':
                                row2.show();
                                row5.hide();
                                row6.hide();
                                commandTypeSelectField.show();
                                resetTypeSelectField.hide();
                                switch (commandType) {
                                    case 'read':
                                        row3.hide();
                                        row4.show();
                                        readDataTypeSelectField.show();
                                        break;
                                    case 'write':
                                        row3.show();
                                        row4.hide();
                                        readDataTypeSelectField.hide();
                                        break;
                                    case 'query':
                                        row3.show();
                                        row4.show();
                                        readDataTypeSelectField.show();
                                        break;
                                }
                                break;
                            case 'delay':
                                row2.hide();
                                row3.hide();
                                row4.hide();
                                row5.show();
                                row6.hide();
                                commandTypeSelectField.hide();
                                readDataTypeSelectField.hide();
                                resetTypeSelectField.hide();
                                break;
                            case 'reset':
                                row3.hide();
                                row4.hide();
                                row5.hide();
                                commandTypeSelectField.hide();
                                readDataTypeSelectField.hide();
                                resetTypeSelectField.show();
                                switch (operation.resetType) {
                                    case 'device':
                                        row2.show();
                                        row6.hide();
                                        break;
                                    case 'interface':
                                        row2.hide();
                                        row6.show();
                                        break;
                                }
                                break;
                            case 'trigger':
                                row2.show();
                                row3.hide();
                                row4.hide();
                                row5.hide();
                                row6.hide();
                                commandTypeSelectField.hide();
                                readDataTypeSelectField.hide();
                                resetTypeSelectField.hide();
                                break;
                                break;
                            default:
                                row2.hide();
                                row3.hide();
                                row4.hide();
                                row5.hide();
                                row6.hide();
                                commandTypeSelectField.hide();
                                readDataTypeSelectField.hide();
                                resetTypeSelectField.hide();
                        }
                        resizeOperation(row);
                    }

                    typeSelectField.on('change', function () {
                        updateVisibleFieldsAndRows();
                    });

                    commandTypeSelectField.on('change', function () {
                        updateVisibleFieldsAndRows();
                    });

                    resetTypeSelectField.on('change', function () {
                        updateVisibleFieldsAndRows();
                    });

                    typeSelectField.val(operation.type);
                    commandTypeSelectField.val(operation.commandType);
                    readDataTypeSelectField.val(operation.readDataType);
                    resetTypeSelectField.val(operation.resetType);

                    typeSelectField.change();
                    commandTypeSelectField.change();
                    readDataTypeSelectField.change();
                    resetTypeSelectField.change();
                },
                resizeItem: resizeOperation,
                removable: true,
                sortable: true
            });

            if (!this.operations) this.operations = [];
            container.editableList('addItems', this.operations);
        },
        oneditsave: function () {
            var operations = $('#node-input-operation-container').editableList('items');
            var node = this;
            node.operations = [];
            operations.each(function(index, operation) {
                var type = operation.find('.node-input-operation-type').val();
                var commandType = operation.find('.node-input-operation-command-type').val();
                var readDataType = operation.find('.node-input-operation-read-data-type').val();
                var resetType = operation.find('.node-input-operation-reset-type').val();
                var unitIdField = operation.find('.node-input-operation-unitId');
                var interfaceIdField = operation.find('.node-input-operation-interfaceId');
                var writeDataField = operation.find('.node-input-operation-write-data');
                var responseTagField = operation.find('.node-input-operation-response-tag');
                var delayField = operation.find('.node-input-operation-delay');
                var r = {
                    type: type,
                    unitId: unitIdField.typedInput('value'),
                    interfaceId: interfaceIdField.typedInput('value'),
                    commandType: commandType,
                    writeData: writeDataField.typedInput('value'),
                    readDataType: readDataType,
                    responseTag: responseTagField.typedInput('value'),
                    delay: delayField.typedInput('value'),
                    resetType: resetType,
                    unitIdPropertyType: unitIdField.typedInput('type'),
                    interfaceIdPropertyType: interfaceIdField.typedInput('type'),
                    writeDataPropertyType: writeDataField.typedInput('type'),
                    responseTagPropertyType: responseTagField.typedInput('type'),
                    delayPropertyType: delayField.typedInput('type')

                };
                node.operations.push(r);
            });
        },
        oneditresize: function (size) {
            var rows = $('#dialog-form>div:not(.node-input-operation-container-row)');
            var height = size.height;
            rows.each((index, row) => height -= $(row).outerHeight(true));
            var editorRow = $('#dialog-form>div.node-input-operation-container-row');
            height -= (parseInt(editorRow.css('marginTop')) + parseInt(editorRow.css('marginBottom')));
            $('#node-input-operation-container').editableList('height', height);
        }
    });
</script>